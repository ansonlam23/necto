---
phase: 01-core-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - contracts/ComputeRouter.sol
  - contracts/ProviderRegistry.sol
  - contracts/JobRegistry.sol
  - contracts/Escrow.sol
  - hardhat.config.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Smart contracts compile without errors"
    - "Provider registry can store provider metadata and rates"
    - "Job registry can create and complete jobs"
    - "Escrow can lock and release USDC payments"
    - "Contracts support both Tracked and Untracked modes"
  artifacts:
    - path: "contracts/ComputeRouter.sol"
      provides: "Main contract orchestrating provider registry, job registry, and escrow"
      exports: ["ComputeRouter"]
    - path: "contracts/ProviderRegistry.sol"
      provides: "Provider registration and rate management"
      exports: ["ProviderRegistry"]
    - path: "contracts/JobRegistry.sol"
      provides: "Job creation and completion tracking"
      exports: ["JobRegistry"]
    - path: "contracts/Escrow.sol"
      provides: "USDC payment locking and release"
      exports: ["Escrow"]
    - path: "hardhat.config.ts"
      provides: "Hardhat configuration for ADI Testnet"
      contains: ["0g-testnet", "chainId: 16602"]
  key_links:
    - from: "ComputeRouter"
      to: "ProviderRegistry"
      via: "contract inheritance or composition"
    - from: "ComputeRouter"
      to: "JobRegistry"
      via: "contract inheritance or composition"
    - from: "ComputeRouter"
      to: "Escrow"
      via: "contract inheritance or composition"
    - from: "JobRegistry"
      to: "Escrow"
      via: "job completion triggers payment release"
---

<objective>
Create the foundational smart contracts for the compute marketplace: ComputeRouter, ProviderRegistry, JobRegistry, and Escrow. These contracts handle provider registration, job lifecycle, and USDC payment settlement on ADI Testnet.

Purpose: Core infrastructure for the two-sided marketplace — providers register, buyers create jobs, and payments settle on-chain.
Output: Four Solidity contracts with Hardhat configuration for ADI Testnet deployment.
</objective>

<execution_context>
@/home/julius/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/julius/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-core-infrastructure/01-CONTEXT.md
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Hardhat environment and base contracts</name>
  <files>hardhat.config.ts, .env.example, contracts/ProviderRegistry.sol, contracts/JobRegistry.sol, contracts/Escrow.sol</files>
  <action>
    Install Hardhat with TypeScript support and initialize project structure:
    1. Install dependencies: `npm install --save-dev hardhat @nomicfoundation/hardhat-toolbox typescript ts-node typechain @typechain/ethers-v6`
    2. Create `hardhat.config.ts` with ADI Testnet configuration (chainId 16602, Cancun EVM version)
    3. Create `.env.example` with placeholders: PRIVATE_KEY, OG_RPC_URL, OG_INDEXER_URL
    4. Create base contract `contracts/ProviderRegistry.sol` with:
       - Provider struct: owner, metadata URI, isActive, registeredAt
       - registerProvider(string metadataURI) external
       - updateProviderStatus(bool isActive) external
       - getProvider(address owner) external view returns (Provider memory)
       - ProviderRegistered/ProviderUpdated events
    5. Create base contract `contracts/JobRegistry.sol` with:
       - Job struct: id, buyer, provider, amount, status, tracked, createdAt, completedAt, reasoningHash
       - createJob(address provider, uint256 amount, bool tracked, string memory reasoningHash) external returns (bytes32 jobId)
       - completeJob(bytes32 jobId) external
       - getJob(bytes32 jobId) external view returns (Job memory)
       - JobCreated/JobCompleted events
    6. Create base contract `contracts/Escrow.sol` with:
       - Escrow struct: jobId, buyer, provider, amount, status, createdAt
       - lockFunds(bytes32 jobId, address provider) external payable
       - releaseFunds(bytes32 jobId) external
       - refund(bytes32 jobId) external (with 7-day timeout)
       - FundsLocked/FundsReleased/FundsRefunded events
    
    Use Solidity ^0.8.19 with Cancun EVM version as required by 0G Chain.
    Add proper access control (onlyJobRegistry modifier for Escrow).
    Include reentrancy protection (ReentrancyGuard from OpenZeppelin).
  </action>
  <verify>
    Run `npx hardhat compile` — contracts should compile without errors
  </verify>
  <done>
    Hardhat configured for ADI Testnet (chainId 16602), ProviderRegistry/JobRegistry/Escrow contracts created and compiling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ComputeRouter.sol with integration</name>
  <files>contracts/ComputeRouter.sol</files>
  <action>
    Create the main ComputeRouter contract that integrates all modules:
    1. Create `contracts/ComputeRouter.sol` that inherits or composes the three base contracts
    2. Implement the unified interface:
       - registerProvider(string metadataURI) → calls ProviderRegistry
       - createJob(address provider, bool tracked, string memory reasoningHash) external payable → calls JobRegistry.createJob AND Escrow.lockFunds
       - completeJob(bytes32 jobId) external → calls JobRegistry.completeJob AND Escrow.releaseFunds
       - getProvider(address owner) external view
       - getJob(bytes32 jobId) external view
       - getEscrow(bytes32 jobId) external view
    3. Add USDC support using IERC20 interface:
       - Accept USDC instead of native token for payments
       - Add approve/transferFrom pattern for ERC20
       - Store USDC token address in constructor
    4. Implement Tracked/Untracked mode support:
       - Pass `tracked` boolean through job creation
       - Store in Job struct
       - Emit events with mode flag
    5. Add lightweight RBAC for Tracked mode (ADI-05):
       - Role struct: Admin, Viewer, User
       - grantRole(bytes32 role, address account) external onlyAdmin
       - revokeRole(bytes32 role, address account) external onlyAdmin
       - hasRole(bytes32 role, address account) external view returns (bool)
       - Roles: keccak256("ADMIN_ROLE"), keccak256("VIEWER_ROLE"), keccak256("USER_ROLE")
    6. Add events for frontend integration:
       - ComputeJobCreated(bytes32 indexed jobId, address indexed buyer, address indexed provider, uint256 amount, bool tracked)
       - ComputeJobCompleted(bytes32 indexed jobId, uint256 completedAt)
    
    Use OpenZeppelin contracts (install @openzeppelin/contracts): AccessControl for RBAC, ReentrancyGuard, IERC20.
    Ensure all external calls check permissions appropriately.
    Document the contract architecture with NatSpec comments.
  </action>
  <verify>
    Run `npx hardhat compile` — ComputeRouter should compile with all dependencies
  </verify>
  <done>
    ComputeRouter.sol created with provider registry, job registry, USDC escrow, and RBAC. All contracts compile successfully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create deployment scripts and type definitions</name>
  <files>scripts/deploy.ts, src/types/contracts.ts</files>
  <action>
    Create deployment infrastructure for ADI Testnet:
    1. Create `scripts/deploy.ts` Hardhat deployment script:
       - Deploy ProviderRegistry, JobRegistry, Escrow as separate or unified (Claude's discretion)
       - Deploy ComputeRouter with USDC token address
       - If USDC doesn't exist on testnet, deploy a MockERC20 for testing
       - Log deployed addresses to console and save to JSON file
       - Verify contracts on 0G Chain explorer if possible
    2. Create `src/types/contracts.ts` with TypeScript interfaces:
       - Provider interface matching contract struct
       - Job interface with all fields
       - Escrow interface
       - Enums for JobStatus, EscrowStatus
       - Contract addresses type for different networks
    3. Generate TypeScript types from contracts:
       - Configure typechain in hardhat.config.ts
       - Run compilation to generate typechain-types/
       - Export types from src/types/contracts.ts
    4. Create `.env` setup instructions in README
    
    Use Hardhat's ignition or standard scripts (Claude's discretion based on Hardhat version).
    Include proper error handling and gas estimation.
  </action>
  <verify>
    Run `npx hardhat run scripts/deploy.ts --network 0g-testnet` (dry-run or actual if funded)
  </verify>
  <done>
    Deployment script ready, TypeScript types generated, contracts ready for ADI Testnet deployment
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. All contracts compile without errors: `npx hardhat compile`
2. TypeScript types are generated in typechain-types/
3. Deployment script can be executed: `npx hardhat run scripts/deploy.ts --network 0g-testnet`
4. Contract ABI files exist in artifacts/
</verification>

<success_criteria>
- ComputeRouter.sol integrates ProviderRegistry, JobRegistry, and Escrow
- Contracts support USDC payments (not native token)
- Tracked/Untracked mode flag stored in Job struct
- RBAC roles (Admin, Viewer, User) implemented for Tracked mode
- Hardhat configured for ADI Testnet (chainId 16602, Cancun EVM)
- Deployment script ready for ADI Testnet
- TypeScript contract types generated for frontend integration
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-01-SUMMARY.md`
</output>
