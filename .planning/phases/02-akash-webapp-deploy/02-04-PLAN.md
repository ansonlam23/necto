---
phase: 02-akash-webapp-deploy
plan: 04
type: execute
wave: 4
depends_on:
  - 02-01-PLAN.md
  - 02-02-PLAN.md
  - 02-03-PLAN.md
files_modified:
  - offchain/src/app/api/deployments/route.ts
  - offchain/src/app/api/deployments/[id]/route.ts
  - offchain/src/app/api/deployments/[id]/logs/route.ts
  - offchain/src/app/api/providers/route.ts
  - offchain/src/app/api/escrow/route.ts
  - offchain/src/app/buyer/dashboard/page.tsx
  - offchain/src/components/akash/deployment-list.tsx
autonomous: false
user_setup:
  - service: Akash Console API
    why: "API routes proxy to Console API for real deployments"
    env_vars:
      - name: AKASH_CONSOLE_API_KEY
        source: "Akash Console dashboard"
  - service: Testnet RPC
    why: "Blockchain interactions for testnet USDC escrow"
    env_vars:
      - name: ADI_TESTNET_RPC_URL
        source: "ADI Foundation ADI Testnet endpoint"
must_haves:
  truths:
    - "API routes handle all Akash Console API interactions server-side"
    - "Deployments list shows real deployment status from Console API"
    - "Log streaming endpoint for real-time deployment logs"
    - "Provider discovery endpoint with filtering"
    - "Escrow API handles testnet USDC deposits/refunds"
    - "Dashboard displays deployment timeline and status"
    - "5-minute bid timeout with automatic cleanup"
    - "All endpoints validate requests and handle errors gracefully"
  artifacts:
    - path: "offchain/src/app/api/deployments/route.ts"
      provides: "Deployment creation and listing API"
      exports: ["GET", "POST"]
    - path: "offchain/src/app/api/deployments/[id]/route.ts"
      provides: "Single deployment management API"
      exports: ["GET", "DELETE"]
    - path: "offchain/src/app/api/deployments/[id]/logs/route.ts"
      provides: "Deployment log streaming API"
      exports: ["GET"]
    - path: "offchain/src/app/api/providers/route.ts"
      provides: "Provider discovery API"
      exports: ["GET"]
    - path: "offchain/src/app/api/escrow/route.ts"
      provides: "Escrow management API"
      exports: ["POST", "GET"]
    - path: "offchain/src/app/buyer/dashboard/page.tsx"
      provides: "Buyer dashboard with deployments"
      exports: ["default"]
    - path: "offchain/src/components/akash/deployment-list.tsx"
      provides: "Deployment list component"
      exports: ["DeploymentList", "DeploymentItem"]
  key_links:
    - from: "offchain/src/app/api/deployments/route.ts"
      to: "offchain/src/lib/akash/console-api.ts"
      via: "API uses Console API client"
    - from: "offchain/src/app/buyer/dashboard/page.tsx"
      to: "offchain/src/components/akash/deployment-list.tsx"
      via: "Dashboard uses deployment list"
---

<objective>
Create API routes for deployment management and buyer dashboard. Implement server-side Akash Console API integration, escrow handling, and deployment monitoring interface.

Purpose: Provide RESTful API endpoints for all Akash operations, enable real-time log streaming, and give buyers a dashboard to track their deployments and manage escrow.

Output: Complete API layer with deployment CRUD, log streaming, provider discovery, and buyer dashboard UI.
</objective>

<execution_context>
@/home/julius/.claude/get-shit-done/workflows/execute-plan.md
@/home/julius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-akash-webapp-deploy/02-CONTEXT.md
@.planning/phases/02-akash-webapp-deploy/02-01-PLAN.md
@.planning/phases/02-akash-webapp-deploy/02-02-PLAN.md
@.planning/phases/02-akash-webapp-deploy/02-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deployment API routes</name>
  <files>offchain/src/app/api/deployments/route.ts, offchain/src/app/api/deployments/[id]/route.ts, offchain/src/app/api/deployments/[id]/logs/route.ts</files>
  <action>
    Create `offchain/src/app/api/deployments/route.ts` with:
    - GET: List deployments for authenticated user
    - POST: Create new deployment from SDL
    
    Create `offchain/src/app/api/deployments/[id]/route.ts` with:
    - GET: Get deployment details
    - DELETE: Close/cancel deployment
    
    Create `offchain/src/app/api/deployments/[id]/logs/route.ts` with:
    - GET: Stream logs using Server-Sent Events
    
    Use AkashConsoleClient from lib/akash/console-api.ts.
    Implement proper error handling and validation.
    Add authentication check.
  </action>
  <verify>
    Run `npx eslint offchain/src/app/api/deployments/route.ts` - no lint errors.
    Run `npx eslint offchain/src/app/api/deployments/[id]/route.ts` - no lint errors.
    Run `npx eslint offchain/src/app/api/deployments/[id]/logs/route.ts` - no lint errors.
    Verify API route structure is correct for Next.js App Router.
  </verify>
  <done>
    Deployment API routes with CRUD operations.
    Log streaming endpoint with SSE.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create providers and escrow API routes</name>
  <files>offchain/src/app/api/providers/route.ts, offchain/src/app/api/escrow/route.ts</files>
  <action>
    Create `offchain/src/app/api/providers/route.ts` with:
    - GET: List available providers with optional filters (region, gpuType, maxPrice)
    - Return provider details including specs, pricing, availability
    
    Create `offchain/src/app/api/escrow/route.ts` with:
    - GET: Get escrow status for a job
    - POST: Create escrow deposit (returns transaction data)
    - DELETE: Request refund
    
    For escrow, use testnet USDC contract addresses from environment.
    Return transaction data for client-side signing.
    Do NOT handle private keys server-side.
  </action>
  <verify>
    Run `npx eslint offchain/src/app/api/providers/route.ts` - no lint errors.
    Run `npx eslint offchain/src/app/api/escrow/route.ts` - no lint errors.
    Verify providers route returns mock data structure matching Provider type.
  </verify>
  <done>
    Providers API with filtering support.
    Escrow API returning transaction data for client signing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create deployment list component</name>
  <files>offchain/src/components/akash/deployment-list.tsx</files>
  <action>
    Create `offchain/src/components/akash/deployment-list.tsx` with:
    - DeploymentItem component for individual deployment cards
    - Status badges (pending, active, closed, error)
    - Deployment details (ID, created time, provider, cost)
    - Action buttons (view logs, close deployment)
    - Empty state for no deployments
    - Loading state with skeleton
    - Refresh functionality
    
    Use Card, Badge, Button, Skeleton from shadcn/ui.
    Include icons from lucide-react.
    Support filtering by status.
  </action>
  <verify>
    Run `npx eslint offchain/src/components/akash/deployment-list.tsx` - no lint errors.
    Verify all imports resolve.
    Check status badge colors match deployment states.
  </verify>
  <done>
    DeploymentList with item cards and status display.
    Loading and empty states.
    Refresh functionality.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create buyer dashboard page</name>
  <files>offchain/src/app/buyer/dashboard/page.tsx</files>
  <action>
    Create `offchain/src/app/buyer/dashboard/page.tsx` with:
    - Page header with title and new deployment button
    - Stats overview (active deployments, total spent, etc.)
    - DeploymentList component with tabs (Active, All, Closed)
    - Real-time status updates (polling every 30s)
    - Log viewer modal for viewing deployment logs
    - Escrow balance display
    - Quick actions sidebar
    - Error handling for failed fetches
    
    Integrate with:
    - DeploymentList component
    - API routes for fetching deployments
    - Wagmi for wallet connection check
    - useAkashDeployment hook for actions
    
    Use appropriate shadcn/ui components for layout.
  </action>
  <verify>
    Run `npx eslint offchain/src/app/buyer/dashboard/page.tsx` - no lint errors.
    Verify page builds without errors.
    Test tab switching.
    Ensure wallet connection check works.
  </verify>
  <done>
    Complete buyer dashboard with deployment list.
    Stats overview and quick actions.
    Real-time updates and log viewing.
  </done>
</task>

</tasks>
