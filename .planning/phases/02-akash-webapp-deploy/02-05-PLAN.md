---
phase: 02-akash-webapp-deploy
type: gap-closure
gap_closure: true
plan: 05
depends_on:
  - 02-01-PLAN.md
  - 02-02-PLAN.md
  - 02-03-PLAN.md
  - 02-04-PLAN.md
files_modified:
  - offchain/src/lib/agent/tools/route-to-akash-tool.ts
  - offchain/src/lib/agent/tools/compare-providers-tool.ts
  - offchain/src/lib/agent/agent.ts
  - offchain/src/lib/agent/index.ts
autonomous: true
gap_reference:
  verification_file: .planning/phases/02-akash-webapp-deploy/02-VERIFICATION.md
  gap_id: SYS-06
  gap_truth: "Agent implementation using Google ADK (Agent Development Kit) with Google AI Studio API keys"
---

<objective>
Wrap the Akash router as a Google ADK tool and update the agent architecture for multi-provider scalability.

Purpose: Enable the LLM agent to intelligently route jobs between providers using tools, making it trivial to add io.net, Lambda Labs, etc. in the future.

Output: ADK agent with proper tool-based architecture - routeToAkashTool exposed to LLM, provider comparison tool, and updated agent.ts that delegates to tools instead of hardcoded logic.
</objective>

<execution_context>
@/home/julius/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/julius/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-akash-webapp-deploy/02-CONTEXT.md
@.planning/phases/02-akash-webapp-deploy/02-02-PLAN.md
@.planning/phases/02-akash-webapp-deploy/02-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ADK tool directory and routeToAkashTool</name>
  <files>offchain/src/lib/agent/tools/route-to-akash-tool.ts</files>
  <action>
    Create `offchain/src/lib/agent/tools/` directory.
    
    Create `offchain/src/lib/agent/tools/route-to-akash-tool.ts`:
    - Import `FunctionDeclaration` from @google/adk
    - Import functions from `akash-router.ts` (routeToAkash, isAkashSuitable)
    - Define the tool schema with parameters:
      - jobId: string (required)
      - requirements: object with gpuModel, gpuCount, minMemoryGB, maxPricePerHour, region
      - autoAcceptBid: boolean (optional, default false)
      - bidTimeoutSeconds: number (optional, default 300)
    - Wrap `routeToAkash()` call with proper error handling
    - Return structured result with:
      - success: boolean
      - deployment: AkashDeployment (if successful)
      - provider: selected provider details
      - bids: array of provider bids received
      - logs: routing decision logs
      - error: string (if failed)
      - suitability: { suitable: boolean, score: number, reasons: string[] }
    - Add JSDoc explaining this is an ADK tool for LLM agent
    - Export both the tool definition and a helper function for direct use
  </action>
  <verify>
    Run `npx eslint offchain/src/lib/agent/tools/route-to-akash-tool.ts` - no errors.
    Verify TypeScript imports resolve.
    Check tool schema follows ADK FunctionDeclaration format.
  </verify>
  <done>
    routeToAkashTool.ts exports properly structured ADK tool.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create compareProvidersTool</name>
  <files>offchain/src/lib/agent/tools/compare-providers-tool.ts</files>
  <action>
    Create `offchain/src/lib/agent/tools/compare-providers-tool.ts`:
    - Import from @google/adk and provider types
    - Define tool for comparing multiple provider options
    - Parameters:
      - requirements: JobRequirements
      - providersToCompare: string[] (provider IDs)
    - Implementation:
      - Call routeToAkash with dry-run/simulation mode to get suitability score
      - Future: Will call other provider routers similarly
      - Return comparison table with:
        - provider: name and ID
        - suitable: boolean
        - score: number (0-100)
        - estimatedCost: number (USD/hr)
        - timeToDeploy: string (estimate)
        - pros: string[]
        - cons: string[]
    - Export tool definition for ADK agent
  </action>
  <verify>
    Run `npx eslint offchain/src/lib/agent/tools/compare-providers-tool.ts` - no errors.
    Verify compare logic returns structured data.
  </verify>
  <done>
    compareProvidersTool for multi-provider comparison.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create tools index file</name>
  <files>offchain/src/lib/agent/tools/index.ts</files>
  <action>
    Create `offchain/src/lib/agent/tools/index.ts`:
    - Export all tools: routeToAkashTool, compareProvidersTool
    - Export helper functions for direct programmatic use
    - Add documentation comment explaining the tool architecture:
      "Tools expose provider-specific logic to the LLM agent.
       Adding a new provider = add a new tool here."
  </action>
  <verify>
    Verify exports are correct.
  </verify>
  <done>
    Tools index exports all ADK tools.
  </done>
</task>

<task type="auto">
  <name>Task 4: Refactor agent.ts to use tools</name>
  <files>offchain/src/lib/agent/agent.ts</files>
  <action>
    Rewrite `offchain/src/lib/agent/agent.ts`:
    - Import tools from `./tools`
    - Update `createRoutingAgent` to include all tools:
      ```typescript
      const agent = new LlmAgent({
        name: config.name,
        model: config.model,
        description: `You are a compute marketplace routing agent.
Your job is to intelligently route compute jobs to the best provider.

Available providers:
- Akash Network (decentralized, auction-based pricing)

For each job:
1. Analyze requirements (GPU type, memory, budget, region)
2. Use compareProvidersTool to evaluate all suitable providers
3. Select the best provider based on cost, reliability, and speed
4. Use the appropriate route tool (routeToAkashTool) to execute
5. If tracked mode, submit to blockchain

Always explain your reasoning. Consider price, uptime, and hardware match.`,
        tools: [routeToAkashTool, compareProvidersTool, walletTool]
      })
      ```
    - Remove hardcoded Akash-specific logic from `routeComputeJob`
    - The agent should now delegate to tools - agent.ts becomes thin orchestration layer
    - Keep `routeComputeJob` as entry point but let LLM call tools
    - Update `onThinking` callbacks to reflect tool-based flow
  </action>
  <verify>
    Run `npx eslint offchain/src/lib/agent/agent.ts` - no errors.
    Verify agent creates with new tools array.
    Ensure all imports resolve.
  </verify>
  <done>
    Agent uses tool-based architecture for routing decisions.
  </done>
</task>

<task type="auto">
  <name>Task 5: Update agent index exports</name>
  <files>offchain/src/lib/agent/index.ts</files>
  <action>
    Update `offchain/src/lib/agent/index.ts`:
    - Export tools from `./tools`
    - Keep existing exports (createRoutingAgent, routeComputeJob, etc.)
    - Add comment: "Tools are exported for direct use and ADK integration"
  </action>
  <verify>
    Verify exports are correct.
  </verify>
  <done>
    Agent index exports tools.
  </done>
</task>

<task type="auto">
  <name>Task 6: Update VERIFICATION.md gap status</name>
  <files>.planning/phases/02-akash-webapp-deploy/02-VERIFICATION.md</files>
  <action>
    Update the SYS-06 gap in VERIFICATION.md:
    - Change status from "failed" to "resolved"
    - Update re_verification section with date
    - Add notes: "Agent now uses ADK with tool-based architecture"
    - List new tool files as artifacts
  </action>
  <verify>
    Verify VERIFICATION.md updated correctly.
  </verify>
  <done>
    Gap marked as resolved in verification file.
  </done>
</task>

</tasks>

<acceptance_criteria>
- [ ] routeToAkashTool exposes Akash router to LLM via ADK
- [ ] compareProvidersTool enables multi-provider evaluation
- [ ] Agent uses tools array, not hardcoded logic
- [ ] Adding io.net = create new tool + add to tools array
- [ ] All files pass ESLint
- [ ] VERIFICATION.md updated
</acceptance_criteria>
