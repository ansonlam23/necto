---
phase: 02-akash-webapp-deploy
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - offchain/src/lib/agent/provider-selection.ts
  - offchain/src/lib/akash/sdl-generator.ts
  - offchain/package.json
  - offchain/src/components/akash/sdl-editor.tsx
autonomous: true
gap_closure: true
requirements:
  - SYS-03
  - SYS-04
must_haves:
  truths:
    - "GPU filtering works case-insensitively (nvidia matches NVIDIA)"
    - "Natural language parses GPU count (e.g., '2 GPUs' sets units: 2)"
    - "SDL editor validates YAML syntax in real-time"
  artifacts:
    - path: "offchain/src/lib/agent/provider-selection.ts"
      provides: "Case-insensitive GPU filtering"
      min_lines: 10
    - path: "offchain/src/lib/akash/sdl-generator.ts"
      provides: "parseYAMLToSDL() function"
      min_lines: 30
    - path: "offchain/src/components/akash/sdl-editor.tsx"
      provides: "Real-time YAML validation"
      min_lines: 30
  key_links:
    - from: "sdl-editor.tsx"
      to: "sdl-generator.ts"
      via: "parseYAMLToSDL() import"
    - from: "provider-selection.ts"
      to: "SDL generator"
      via: "Case-insensitive gpuType matching"
---

<objective>
Fix three critical issues blocking deployment: case-sensitive GPU filtering, missing GPU count extraction in natural language, and broken SDL YAML validation.
</objective>

<execution_context>
@/home/julius/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/julius/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/02-akash-webapp-deploy/02-UAT.md
@offchain/src/lib/agent/provider-selection.ts
@offchain/src/lib/akash/sdl-generator.ts
@offchain/src/components/akash/sdl-editor.tsx
@offchain/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix case-sensitive GPU filtering in provider-selection.ts</name>
  <files>offchain/src/lib/agent/provider-selection.ts</files>
  <action>
    Modify the filterProviders function to use case-insensitive GPU type matching.
    
    Change line 178 from:
    `if (filters.gpuType && !p.gpuTypes.includes(filters.gpuType))`
    
    To:
    ```typescript
    if (filters.gpuType) {
      const filterLower = filters.gpuType.toLowerCase();
      const hasMatchingGpu = p.gpuTypes.some(gpu => 
        gpu.toLowerCase().includes(filterLower)
      );
      if (!hasMatchingGpu) return false;
    }
    ```
    
    This fixes the BLOCKER where 'nvidia' (lowercase in SDL) doesn't match 'NVIDIA A100' (uppercase in mock providers).
  </action>
  <verify>
    Run `npx eslint offchain/src/lib/agent/provider-selection.ts` - should pass with no errors
  </verify>
  <done>
    GPU filtering uses case-insensitive comparison, allowing 'nvidia' to match 'NVIDIA A100'
  </done>
</task>

<task type="auto">
  <name>Task 2: Add parseYAMLToSDL function to sdl-generator.ts</name>
  <files>offchain/src/lib/akash/sdl-generator.ts</files>
  <action>
    Add a parseYAMLToSDL() function that converts YAML string back to SdlSpec object.
    
    Add at the end of the file (before exports if any):
    ```typescript
    import YAML from 'js-yaml';
    
    /**
     * Parse YAML string to SDL specification
     */
    export function parseYAMLToSDL(yamlString: string): { sdl: SdlSpec | null; errors: string[] } {
      const errors: string[] = [];
      
      try {
        const parsed = YAML.load(yamlString) as Record<string, unknown>;
        
        if (!parsed || typeof parsed !== 'object') {
          errors.push('Invalid YAML: must be an object');
          return { sdl: null, errors };
        }
        
        // Validate required top-level keys
        if (!parsed.version) errors.push('Missing required field: version');
        if (!parsed.services) errors.push('Missing required field: services');
        if (!parsed.deployment) errors.push('Missing required field: deployment');
        if (!parsed.profiles) errors.push('Missing required field: profiles');
        
        if (errors.length > 0) {
          return { sdl: null, errors };
        }
        
        // Cast to SdlSpec (runtime validation is lenient)
        return { sdl: parsed as SdlSpec, errors: [] };
      } catch (err) {
        errors.push(`YAML parse error: ${err instanceof Error ? err.message : String(err)}`);
        return { sdl: null, errors };
      }
    }
    ```
  </action>
  <verify>
    Run `npx eslint offchain/src/lib/akash/sdl-generator.ts` - should pass
  </verify>
  <done>
    parseYAMLToSDL function exists and validates YAML structure
  </done>
</task>

<task type="auto">
  <name>Task 3: Install js-yaml and update SDL editor validation</name>
  <files>offchain/package.json, offchain/src/components/akash/sdl-editor.tsx</files>
  <action>
    First, install js-yaml dependency:
    ```bash
    cd offchain && npm install js-yaml @types/js-yaml --save
    ```
    
    Then update sdl-editor.tsx handleYamlChange function (lines 64-69):
    
    Replace:
    ```typescript
    const handleYamlChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
      setYaml(e.target.value);
      setIsModified(true);
      // Note: Full YAML parsing would require js-yaml library
      // For now, we just track modifications
    };
    ```
    
    With:
    ```typescript
    import { parseYAMLToSDL } from '@/lib/akash/sdl-generator';
    
    const handleYamlChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
      const newYaml = e.target.value;
      setYaml(newYaml);
      setIsModified(true);
      
      // Parse and validate YAML
      const { sdl, errors } = parseYAMLToSDL(newYaml);
      setIsValid(errors.length === 0);
      setValidationErrors(errors);
      
      // Call onChange if valid
      if (sdl && onChange) {
        onChange(sdl, newYaml);
      }
    };
    ```
    
    Also add onChange to the destructured props at the top of the component (it's currently missing from destructuring but declared in props interface).
  </action>
  <verify>
    Run `cd offchain && npm run lint` - should pass with no errors
    Run `cd offchain && npm run build` - should complete successfully
  </verify>
  <done>
    js-yaml installed, SDL editor validates YAML in real-time with error display
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify natural language GPU count extraction</name>
  <files>offchain/src/lib/akash/sdl-generator.ts</files>
  <action>
    Verify the parseNaturalLanguage function already has GPU count extraction. According to the UAT root cause analysis (line 115-119), the function at line 302 always sets units: 1. But from our code read (lines 300-306), it appears the regex already exists:
    
    ```typescript
    const gpuCountMatch = lower.match(/(\d+)\s*(?:x\s*)?gpu/);
    const gpuUnits = gpuCountMatch ? parseInt(gpuCountMatch[1], 10) : 1;
    requirements.gpu = { units: gpuUnits };
    ```
    
    This code should work for "2 GPUs" input. The issue might be that the pattern "(\d+)\s*(?:x\s*)?gpu" doesn't match "2 GPUs" because of the plural 's'.
    
    Fix by updating the regex on line 303 to:
    ```typescript
    const gpuCountMatch = lower.match(/(\d+)\s*(?:x\s*)?gpus?/);
    ```
    
    This makes the 's' optional, matching both "2 gpu" and "2 gpus".
  </action>
  <verify>
    Run `npx eslint offchain/src/lib/akash/sdl-generator.ts` - should pass
  </verify>
  <done>
    GPU count regex updated to handle both "gpu" and "gpus" plural forms
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. GPU filtering is case-insensitive (nvidia matches NVIDIA A100)
2. parseYAMLToSDL function exists and handles errors gracefully
3. SDL editor shows validation errors when YAML is invalid
4. Natural language "2 GPUs" correctly extracts GPU count
5. All builds pass
</verification>

<success_criteria>
- provider-selection.ts uses case-insensitive GPU matching
- sdl-generator.ts exports parseYAMLToSDL function
- GPU count regex handles plural "gpus" form
- js-yaml is in package.json dependencies
- sdl-editor.tsx validates YAML on every change
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-akash-webapp-deploy/02-09-SUMMARY.md`
</output>
